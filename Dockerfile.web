# syntax=docker/dockerfile:1

# Build stage
FROM node:25-alpine AS builder

# Install pnpm via npm (corepack not reliable in alpine)
RUN npm install -g pnpm@10

WORKDIR /app

# Copy workspace configuration
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY packages/web/package.json ./packages/web/
COPY packages/shared/package.json ./packages/shared/

# Install all dependencies (including devDependencies for build)
RUN pnpm install --frozen-lockfile

# Copy source code
COPY packages/web ./packages/web
COPY packages/shared ./packages/shared

# Build SvelteKit app
RUN pnpm --filter web build

# Production stage
FROM node:25-alpine

# Install pnpm via npm (corepack not reliable in alpine)
RUN npm install -g pnpm@10

WORKDIR /app

# Copy workspace configuration
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY packages/web/package.json ./packages/web/
COPY packages/shared/package.json ./packages/shared/

# Install production dependencies only
RUN pnpm install --frozen-lockfile --prod

# Copy built artifacts
COPY --from=builder /app/packages/web/build ./packages/web/build
COPY packages/shared ./packages/shared

# Run as non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001 && \
    chown -R nodejs:nodejs /app

USER nodejs

EXPOSE 3000

ENV NODE_ENV=production

WORKDIR /app/packages/web

CMD ["node", "build"]
